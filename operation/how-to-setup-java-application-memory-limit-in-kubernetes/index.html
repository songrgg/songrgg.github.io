<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>How to set up a reasonable memory limit for Java applications in Kubernetes - Blog | Songrgg</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Blog | Songrgg"><meta name="msapplication-TileImage" content="/images/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Blog | Songrgg"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="This article introduces some discovery of the Java memory usage in Kubernetes and how to set up a reasonable memory request&amp;#x2F;limit based on the Java heap requirement and the memory usage of the applica"><meta property="og:type" content="article"><meta property="og:title" content="How to set up a reasonable memory limit for Java applications in Kubernetes"><meta property="og:url" content="https://songrgg.github.io/operation/how-to-setup-java-application-memory-limit-in-kubernetes/"><meta property="og:site_name" content="Blog | Songrgg"><meta property="og:description" content="This article introduces some discovery of the Java memory usage in Kubernetes and how to set up a reasonable memory request&amp;#x2F;limit based on the Java heap requirement and the memory usage of the applica"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://songrgg.github.io/images/memory-usage.webp"><meta property="article:published_time" content="2021-11-28T19:11:50.000Z"><meta property="article:modified_time" content="2021-11-28T20:37:10.611Z"><meta property="article:author" content="songrgg"><meta property="article:tag" content="kubernetes"><meta property="article:tag" content="monitoring"><meta property="article:tag" content="jvm"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/memory-usage.webp"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://songrgg.github.io/operation/how-to-setup-java-application-memory-limit-in-kubernetes/"},"headline":"How to set up a reasonable memory limit for Java applications in Kubernetes","image":["https://songrgg.github.io/images/memory-usage.webp"],"datePublished":"2021-11-28T19:11:50.000Z","dateModified":"2021-11-28T20:37:10.611Z","author":{"@type":"Person","name":"songrgg"},"publisher":{"@type":"Organization","name":"Blog | Songrgg","logo":{"@type":"ImageObject","url":{"text":"SongRong's Experience"}}},"description":"This article introduces some discovery of the Java memory usage in Kubernetes and how to set up a reasonable memory request&#x2F;limit based on the Java heap requirement and the memory usage of the applica"}</script><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><!--!--><script src="https://www.googletagmanager.com/gtag/js?id=UA-74431120-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-74431120-1');</script><!--!--><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Blog | Songrgg" type="application/atom+xml">
</head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">SongRong&#039;s Experience</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/images/memory-usage.webp" alt="How to set up a reasonable memory limit for Java applications in Kubernetes"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-11-28T19:11:50.000Z" title="28/11/2021, 20:11:50">2021-11-28</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-11-28T20:37:10.611Z" title="28/11/2021, 21:37:10">2021-11-28</time></span><span class="level-item"><a class="link-muted" href="/categories/operation/">operation</a></span><span class="level-item">12 minutes read (About 1778 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">How to set up a reasonable memory limit for Java applications in Kubernetes</h1><div class="content"><p>This article introduces some discovery of the Java memory usage in Kubernetes and how to set up a reasonable memory request/limit based on the Java heap requirement and the memory usage of the application.</p>
<span id="more"></span>

<h2 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h2><p>The trigger for me to look up the memory usage of Java applications in Kubernets is the increased OOM events in production, after investigation, it was not caused by JVM heap shortage, so I need to investigate where the non-heap memory goes.<br>(If you’re not familiar with the OOM events, you can check the article “<a href="https://songrgg.github.io/operation/how-to-alert-for-Pod-Restart-OOMKilled-in-Kubernetes/">How to alert for Pod Restart &amp; OOMKilled in Kubernetes
</a>“)</p>
<h2 id="Container-Metrics"><a href="#Container-Metrics" class="headerlink" title="Container Metrics"></a>Container Metrics</h2><p>There are several metrics for memory usage in Kubernetes,</p>
<ol>
<li><code>container_memory_rss</code> (<a target="_blank" rel="noopener" href="https://github.com/google/cadvisor/blob/master/docs/storage/prometheus.md">cadvisor</a>)<br>The amount of anonymous and swap cache memory (includes transparent hugepages).</li>
<li><code>container_memory_working_set_bytes</code> (<a target="_blank" rel="noopener" href="https://github.com/google/cadvisor/blob/master/docs/storage/prometheus.md">cadvisor</a>)<br>The amount of working set memory, this includes recently accessed memory, dirty memory, and kernel memory. Working set is &lt;= “usage” and it equals to Usage minus total_inactive_file.</li>
<li><code>resident set size</code><br>It is container_memory_rss + file_mapped (file_mapped is accounted only when the memory CGroup is owner of page cache)</li>
</ol>
<p>For Kubernetes, it depends on <code>container_memory_working_set_bytes</code> to oom-kill the container which exceeds the memory limit, we’ll use this metric in the following sections.</p>
<h2 id="Heap-Usage-lt-lt-Memory-Limit"><a href="#Heap-Usage-lt-lt-Memory-Limit" class="headerlink" title="Heap Usage &lt;&lt; Memory Limit"></a>Heap Usage &lt;&lt; Memory Limit</h2><p>After we noticed several OOMs in the production, it’s time to figure out the root cause. According to the JVM metrics, I found the heap size was way less than the Kubernetes memory usage, let’s check an sample, its memory usage upper limit is as high as 90% of the total memory size.</p>
<p>initial and max heap size is 1.5G Set by <code>XX:InitialHeapSize=1536m -XX:MaxHeapSize=1536m -XX:MaxGCPauseMillis=50</code><br>Kubernetes request and memory limit is 3G set by deployment.yaml,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">resources:</span><br><span class="line">  limits:</span><br><span class="line">    memory: 3Gi</span><br><span class="line">  requests:</span><br><span class="line">    memory: 3Gi</span><br></pre></td></tr></table></figure>

<p>In the monitoring dashboard, Kubernetes memory usage is close to 90% of the memory limit which is 2.7G</p>
<p>In other words, the non-heap memory took 2.7G-1.5G = 1.2G.</p>
<h2 id="A-close-up-on-Java-memory"><a href="#A-close-up-on-Java-memory" class="headerlink" title="A close-up on Java memory"></a>A close-up on Java memory</h2><p>JVM contains heap and non-heap memory, let’s take a sample. The data is from an application with <code>XX:InitialHeapSize=1536m -XX:MaxHeapSize=1536m -XX:MaxGCPauseMillis=50</code></p>
<h3 id="Heap"><a href="#Heap" class="headerlink" title="Heap"></a>Heap</h3><p>If we set the max size of the heap, we can consider the upper limit is fixed and heap size is 1.5G, we can divide the heap memory into Eden, Survivor, Old regions if we were using G1 as our GC algorithm.</p>
<p>We can check heap info by <code>jcmd</code>, as we can see the used heap 593M is way less than the committed size <code>1.5G</code>, so we are good with the heap usage.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bash-4.2$ jcmd 99 GC.heap_info</span><br><span class="line">99:</span><br><span class="line"> garbage-first heap   total 1572864K, used 608214K [0x00000000a0000000, 0x0000000100000000)</span><br><span class="line">  region size 1024K, 255 young (261120K), 1 survivors (1024K)</span><br><span class="line"> Metaspace       used 82997K, capacity 85390K, committed 89168K, reserved 1126400K</span><br><span class="line">  class space    used 9600K, capacity 10640K, committed 11980K, reserved 1048576K</span><br><span class="line">Non-Heap Analysis with NMT</span><br></pre></td></tr></table></figure>

<p>To get more debug information, I enabled the <code>native memory tracking</code> (switch on Native memory tracking by adding XX:NativeMemoryTracking=[off | summary | detail] to the Java options) in the app, I chose <code>detail</code> to show more details of the memory usage.</p>
<p>After the application ran for 5 days, the memory usage was increasing slowly to 78.29% of the memory limit (3G), namely 2.35G.</p>
<p>Let’s use jcmd to show where the memory went,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">bash-4.2$ jcmd 99 VM.native_memory</span><br><span class="line">99:</span><br><span class="line"></span><br><span class="line">Native Memory Tracking:</span><br><span class="line"></span><br><span class="line">Total: reserved=3597274KB, committed=2291546KB</span><br><span class="line">-                 Java Heap (reserved=1572864KB, committed=1572864KB)</span><br><span class="line">                            (mmap: reserved=1572864KB, committed=1572864KB)</span><br><span class="line"></span><br><span class="line">-                     Class (reserved=1128971KB, committed=91739KB)</span><br><span class="line">                            (classes <span class="comment">#13083)</span></span><br><span class="line">                            (  instance classes <span class="comment">#12390, array classes #693)</span></span><br><span class="line">                            (malloc=2571KB <span class="comment">#40364)</span></span><br><span class="line">                            (mmap: reserved=1126400KB, committed=89168KB)</span><br><span class="line">                            (  Metadata:   )</span><br><span class="line">                            (    reserved=77824KB, committed=77188KB)</span><br><span class="line">                            (    used=73396KB)</span><br><span class="line">                            (    free=3792KB)</span><br><span class="line">                            (    waste=0KB =0.00%)</span><br><span class="line">                            (  Class space:)</span><br><span class="line">                            (    reserved=1048576KB, committed=11980KB)</span><br><span class="line">                            (    used=9601KB)</span><br><span class="line">                            (    free=2379KB)</span><br><span class="line">                            (    waste=0KB =0.00%)</span><br><span class="line"></span><br><span class="line">-                    Thread (reserved=73325KB, committed=7621KB)</span><br><span class="line">                            (thread <span class="comment">#71)</span></span><br><span class="line">                            (stack: reserved=72960KB, committed=7256KB)</span><br><span class="line">                            (malloc=252KB <span class="comment">#428)</span></span><br><span class="line">                            (arena=113KB <span class="comment">#140)</span></span><br><span class="line"></span><br><span class="line">-                      Code (reserved=250907KB, committed=48115KB)</span><br><span class="line">                            (malloc=3219KB <span class="comment">#15038)</span></span><br><span class="line">                            (mmap: reserved=247688KB, committed=44896KB)</span><br><span class="line"></span><br><span class="line">-                        GC (reserved=131736KB, committed=131736KB)</span><br><span class="line">                            (malloc=40392KB <span class="comment">#703266)</span></span><br><span class="line">                            (mmap: reserved=91344KB, committed=91344KB)</span><br><span class="line"></span><br><span class="line">-                  Compiler (reserved=965KB, committed=965KB)</span><br><span class="line">                            (malloc=832KB <span class="comment">#1061)</span></span><br><span class="line">                            (arena=133KB <span class="comment">#5)</span></span><br><span class="line"></span><br><span class="line">-                  Internal (reserved=371646KB, committed=371646KB)</span><br><span class="line">                            (malloc=371614KB <span class="comment">#2010417)</span></span><br><span class="line">                            (mmap: reserved=32KB, committed=32KB)</span><br><span class="line"></span><br><span class="line">-                     Other (reserved=899KB, committed=899KB)</span><br><span class="line">                            (malloc=899KB <span class="comment">#70)</span></span><br><span class="line"></span><br><span class="line">-                    Symbol (reserved=18735KB, committed=18735KB)</span><br><span class="line">                            (malloc=16042KB <span class="comment">#163964)</span></span><br><span class="line">                            (arena=2693KB <span class="comment">#1)</span></span><br><span class="line"></span><br><span class="line">-    Native Memory Tracking (reserved=46557KB, committed=46557KB)</span><br><span class="line">                            (malloc=513KB <span class="comment">#7270)</span></span><br><span class="line">                            (tracking overhead=46044KB)</span><br><span class="line"></span><br><span class="line">-               Arena Chunk (reserved=178KB, committed=178KB)</span><br><span class="line">                            (malloc=178KB)</span><br><span class="line"></span><br><span class="line">-                   Logging (reserved=4KB, committed=4KB)</span><br><span class="line">                            (malloc=4KB <span class="comment">#187)</span></span><br><span class="line"></span><br><span class="line">-                 Arguments (reserved=24KB, committed=24KB)</span><br><span class="line">                            (malloc=24KB <span class="comment">#493)</span></span><br><span class="line"></span><br><span class="line">-                    Module (reserved=208KB, committed=208KB)</span><br><span class="line">                            (malloc=208KB <span class="comment">#1919)</span></span><br><span class="line"></span><br><span class="line">-              Synchronizer (reserved=246KB, committed=246KB)</span><br><span class="line">                            (malloc=246KB <span class="comment">#2070)</span></span><br><span class="line"></span><br><span class="line">-                 Safepoint (reserved=8KB, committed=8KB)</span><br><span class="line">                            (mmap: reserved=8KB, committed=8KB)</span><br></pre></td></tr></table></figure>

<p>As the output said, the total committed memory is <strong>2.18G</strong>, committed heap size is the same as we specified, <strong>1.5G</strong>.</p>
<p>For the other sections, <code>Internal</code> took <strong>362M</strong> (371646KB), <code>GC</code> took <strong>128M</strong> (131736KB), <code>Class</code> took <strong>89M</strong> (91739KB), <code>Code</code> took 47M (48115KB), <code>Symbol</code> took 18M (18735KB), <code>Thread</code> took 7M, …</p>
<p>(Didn’t take Native Memory Tracking into account because it was the overhead of the tracing, not the real situation in production.)</p>
<p>Since I set an NMT baseline early, we can run <code>jcmd &lt;process-id&gt; VM.native_memory detail.diff</code> to know which method consumed the memory.</p>
<p>As the output below (full output), I omitted some sections which didn’t increase a lot. Compared to the baseline, the total committed memory increased <strong>437M</strong> (448201KB), the Internal section increased the most, <strong>361M</strong> (373425KB).</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Native Memory Tracking:</span><br><span class="line"></span><br><span class="line">Total: reserved=3599409KB +443893KB, committed=2293681KB +448201KB</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-                      Code (reserved=250907KB +1KB, committed=48115KB +4321KB)</span><br><span class="line">                            (malloc=3219KB +1KB #15038 +444)</span><br><span class="line">                            (mmap: reserved=247688KB, committed=44896KB +4320KB)</span><br><span class="line"></span><br><span class="line">-                        GC (reserved=131889KB +31893KB, committed=131889KB +31893KB)</span><br><span class="line">                            (malloc=40545KB +31893KB #706519 +672802)</span><br><span class="line">                            (mmap: reserved=91344KB, committed=91344KB)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">-                  Internal (reserved=373425KB +369869KB, committed=373425KB +369869KB)</span><br><span class="line">                            (malloc=373393KB +369869KB #2020176 +2003461)</span><br><span class="line">                            (mmap: reserved=32KB, committed=32KB)</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">[0x00007ff2b5ab0cb1] GCNotifier::pushNotification(GCMemoryManager*, char const*, char const*)+0x71</span><br><span class="line">[0x00007ff2b5e099ce] GCMemoryManager::gc_end(bool, bool, bool, bool, GCCause::Cause, bool)+0x27e</span><br><span class="line">[0x00007ff2b5e0b95a] TraceMemoryManagerStats::~TraceMemoryManagerStats()+0x2a</span><br><span class="line">[0x00007ff2b5a537f8] G1CollectedHeap::do_collection_pause_at_safepoint(double)+0x8a8</span><br><span class="line">                             (malloc=31508KB type=Internal +31303KB #672175 +667804)</span><br><span class="line"></span><br><span class="line">[0x00007ff2b5e091b9] GCStatInfo::GCStatInfo(int)+0x29</span><br><span class="line">[0x00007ff2b5ab0c8d] GCNotifier::pushNotification(GCMemoryManager*, char const*, char const*)+0x4d</span><br><span class="line">[0x00007ff2b5e099ce] GCMemoryManager::gc_end(bool, bool, bool, bool, GCCause::Cause, bool)+0x27e</span><br><span class="line">[0x00007ff2b5e0b95a] TraceMemoryManagerStats::~TraceMemoryManagerStats()+0x2a</span><br><span class="line">                             (malloc=168044KB type=Internal +166951KB #672175 +667804)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>You can find out the memory in Internal was consumed by <code>TraceMemoryManagerStats::~TraceMemoryManagerStats()</code> which is related to GC, so it seems GC will create some GC data and the data size is slowly increasing. GC+Internal consumed 493M. So now we know where the non-heap memory goes.</p>
<h2 id="G1-Tuning"><a href="#G1-Tuning" class="headerlink" title="G1 Tuning?"></a>G1 Tuning?</h2><p>Java 11 uses <a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/gctuning/garbage-first-garbage-collector-tuning.html#GUID-0BB3B742-A985-4D5E-A9C5-433A127FE0F6">G1</a> as the default GC algorithm, <a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/gctuning/concurrent-mark-sweep-cms-collector.html#GUID-FF8150AC-73D9-4780-91DD-148E63FA1BFF">CMS</a> (Concurrent Mark Sweep) is deprecated and Java 11 mentioned</p>
<blockquote>
<p>The general recommendation is to use G1 with its default settings, eventually giving it a different pause-time goal and setting a maximum Java heap size by using -Xmx if desired.</p>
</blockquote>
<p>So that means by using G1, a complicated configuration is not that necessary, you just need to make a wish and G1 will try its best to implement it. It also indicates a bit why G1 will consume more and more memory, it might gather some information about the memory behavior to optimize the memory allocation.</p>
<p>To fit a Java application to the Kubernetes, we need to specify several things:</p>
<h3 id="InitialHeapSize-and-MaxHeapSize"><a href="#InitialHeapSize-and-MaxHeapSize" class="headerlink" title="InitialHeapSize and MaxHeapSize"></a>InitialHeapSize and MaxHeapSize</h3><p>Setting this is to limit the heap memory, setting them to the same value will reduce the heap resizing. You can either set the MaxHeapSize to a static value based on the usage or to a ratio of the memory limit like 50%, 60% depending on your real usage. So these two goals will conflict, in most cases, we set our goal of the pause time and G1 will configure based on the goal.</p>
<h3 id="MaxGCPauseMillis"><a href="#MaxGCPauseMillis" class="headerlink" title="MaxGCPauseMillis"></a>MaxGCPauseMillis</h3><p>The default value of it is 200, G1 will try to balance the throughout and the pause time based on this value. There are two directions in GC tuning:“Increase the throughout” means reducing the overall GC time.<br>“Improve the GC pause time” means doing GC more frequently, for example, it will reduce the size of Young region (eden, survivor region) to trigger the young GC more often.</p>
<h2 id="Calculate-the-required-memory-based-on-monitoring"><a href="#Calculate-the-required-memory-based-on-monitoring" class="headerlink" title="Calculate the required memory based on monitoring"></a>Calculate the required memory based on monitoring</h2><p>As the memory analysis showed, <code>the required memory = the max heap size + JVM non-heap (GC, Metaspace, Code, etc.)</code>, considering the application might need more native memory when using JNI APIs, like <code>java.util.zip.Inflater</code> will allocate some native memory for (de)compression.</p>
<p><strong>It’s hard to give an exact memory limit at first, we can always start with a loose limit and leave more room for the non-heap. After the application runs in the production for some time and the metrics are in place, we can adjust the memory limit based on the monitoring data.</strong></p>
<p>To help the developers to realize if the memory limit is reasonable, we can set some thresholds for the application resource usage, if the app falls into these holes, we will generate some warnings to the developers.</p>
<p>Memory Request is too high = 0.6 &gt;= mem_usage(p95) / mem_request<br>Memory Request is too low = 0.9 &lt;= mem_usage(p95) / mem_request<br>Memory Limit is too low = 0.85 &lt;= mem_usage(p95) / mem_limit</p>
<p>The prometheus we use is memory usage P95 in last 7 days.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">quantile_over_time(</span><br><span class="line">    0.95,</span><br><span class="line">    max by (namespace, container) (container_memory_working_set_bytes&#123;namespace=~&quot;&lt;namespace&gt;.*&quot;, container=&quot;&lt;container&gt;&quot;, pod=~&quot;&lt;pod&gt;-.+&quot;&#125;)[7d:]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>You can put the metrics on the monitoring dashboard and trigger alerts of warning level to the responsive team and iterate the memory limit accordingly, when you have more data I think this can also be automated.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>For Java applications, we recommend set the max heap with either a static value or a reasonable ratio (40% ~ 60%) based on the heap usage, make sure to leave enough space for GC and other native memory usage.</p>
<p>For other applications, we can set up the required memory based on the monitoring data, we should always give enough free memory for the application, a good start is the three limitations we set above.</p>
<div><h2>Recommended Posts<span style="font-size:0.45em; color:gray">(Driven by<a target="_blank" rel="noopener" href="https://github.com/huiwang/hexo-recommended-posts">Hexo Recommended Posts plugin</a>)</span></h2><ul><li><a href="https://songrgg.github.io/operation/how-to-alert-for-Pod-Restart-OOMKilled-in-Kubernetes/">How to alert for Pod Restart & OOMKilled in Kubernetes</a></li><li><a href="https://songrgg.github.io/operation/use-traffic-control-simulate-network-chaos/">Use Traffic Control to Simulate Network Chaos in Bare metal & Kubernetes</a></li><li><a href="https://songrgg.github.io/operation/zero-downtime-kubernetes-service-rollout/">Implement zero downtime HTTP service rollout on Kubernetes</a></li><li><a href="https://songrgg.github.io/operation/how-does-prometheus-query-works/">How does Prometheus query work? - Part 1, Step, Query and Range</a></li></ul></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/kubernetes/">kubernetes</a><a class="link-muted mr-2" rel="tag" href="/tags/monitoring/">monitoring</a><a class="link-muted mr-2" rel="tag" href="/tags/jvm/">jvm</a></div><div class="sharethis-inline-share-buttons"></div><script src="//platform-api.sharethis.com/js/sharethis.js#property=5df54e9fee0f770012eb9f87&amp;product=inline-share-buttons&amp;cms=sop" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/programming/python-quickstart-1-basics/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Build a production-ready web application Part 1: Python Basics</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/operation/how-to-alert-for-Pod-Restart-OOMKilled-in-Kubernetes/"><span class="level-item">How to alert for Pod Restart &amp; OOMKilled in Kubernetes</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://songrgg.github.io/operation/how-to-setup-java-application-memory-limit-in-kubernetes/';
            this.page.identifier = 'operation/how-to-setup-java-application-memory-limit-in-kubernetes/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'srjiang' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><!--!--><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">SongRong&#039;s Experience</a><p class="is-size-7"><span>&copy; 2022 songrgg</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>