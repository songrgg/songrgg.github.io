<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>How does Prometheus query work? - Part 1, Step, Query and Range - Blog | Songrgg</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Blog | Songrgg"><meta name="msapplication-TileImage" content="/images/favicon.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Blog | Songrgg"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Prometheus is an opensource time series database, commonly used to gather and calculate monitoring metrics, this article explains how the query works with &amp;#x2F;query_range API."><meta property="og:type" content="article"><meta property="og:title" content="How does Prometheus query work? - Part 1, Step, Query and Range"><meta property="og:url" content="https://songrgg.github.io/operation/how-does-prometheus-query-works/"><meta property="og:site_name" content="Blog | Songrgg"><meta property="og:description" content="Prometheus is an opensource time series database, commonly used to gather and calculate monitoring metrics, this article explains how the query works with &amp;#x2F;query_range API."><meta property="og:locale" content="en_US"><meta property="og:image" content="https://songrgg.github.io/images/prometheus_grafana.webp"><meta property="article:published_time" content="2020-05-31T08:27:50.000Z"><meta property="article:modified_time" content="2020-09-25T13:28:43.000Z"><meta property="article:author" content="songrgg"><meta property="article:tag" content="prometheus"><meta property="article:tag" content="monitoring"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://songrgg.github.io/images/prometheus_grafana.webp"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://songrgg.github.io/operation/how-does-prometheus-query-works/"},"headline":"How does Prometheus query work? - Part 1, Step, Query and Range","image":["https://songrgg.github.io/images/prometheus_grafana.webp"],"datePublished":"2020-05-31T08:27:50.000Z","dateModified":"2020-09-25T13:28:43.000Z","author":{"@type":"Person","name":"songrgg"},"publisher":{"@type":"Organization","name":"Blog | Songrgg","logo":{"@type":"ImageObject","url":{"text":"SongRong's Experience"}}},"description":"Prometheus is an opensource time series database, commonly used to gather and calculate monitoring metrics, this article explains how the query works with &#x2F;query_range API."}</script><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><!--!--><script src="https://www.googletagmanager.com/gtag/js?id=UA-74431120-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-74431120-1');</script><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const $tabMenu = document.querySelector(`a[href="${location.hash}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(location.hash);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Blog | Songrgg" type="application/atom+xml">
</head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">SongRong&#039;s Experience</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="/images/prometheus_grafana.webp" alt="How does Prometheus query work? - Part 1, Step, Query and Range"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2020-05-31T08:27:50.000Z" title="31/05/2020, 16:27:50">2020-05-31</time></span><span class="level-item">Updated&nbsp;<time dateTime="2020-09-25T13:28:43.000Z" title="25/09/2020, 21:28:43">2020-09-25</time></span><span class="level-item"><a class="link-muted" href="/categories/operation/">operation</a></span><span class="level-item">5 minutes read (About 793 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">How does Prometheus query work? - Part 1, Step, Query and Range</h1><div class="content"><p><a target="_blank" rel="noopener" href="https://prometheus.io/">Prometheus</a> is an opensource time series database, commonly used to gather and calculate monitoring metrics, this article explains how the query works with /query_range API.</p>
<span id="more"></span>

<h2 id="Start-a-Prometheus"><a href="#Start-a-Prometheus" class="headerlink" title="Start a Prometheus"></a>Start a Prometheus</h2><p>According to the Prometheus doc, a prometheus server has been started and listens at <code>localhost:9090</code>.</p>
<p>Prometheus browser is a WEB UI that is used to query the metrics for testing, the path is <code>http://localhost:9090/graph</code>, there are two APIs used to query the metrics, the first one is /query (which is used to see the metric value in a specified time point, the other one is <strong>/query_range</strong> used to query the metric during a period.</p>
<h2 id="Metric-types"><a href="#Metric-types" class="headerlink" title="Metric types"></a>Metric types</h2><p>Before we start analyzing a query, we need to know the metric types Prometheus provides:</p>
<h3 id="Counter"><a href="#Counter" class="headerlink" title="Counter"></a>Counter</h3><p>Indicates an cumulative number of the observable, for example the total http request number. This metric value is increasing monotonically increasing. For instance, <code>http_request_total</code> records the total count of HTTP requests the server serves.</p>
<h3 id="Gauge"><a href="#Gauge" class="headerlink" title="Gauge"></a>Gauge</h3><p>A gauge is a metric that represents a single numerical value that can arbitrarily go up and down. For instance, the instance’s CPU usage, it’s changeable all the time.</p>
<h3 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a>Histogram</h3><p>A histogram samples observations (usually things like request durations or response sizes) and counts them in configurable buckets. It also provides a sum of all observed values.<br>The <a target="_blank" rel="noopener" href="https://prometheus.io/docs/practices/histograms/">Prometheus Histograms</a> gives an example, <code>http_request_duration_seconds</code>, consider we have an SLO requirement, 95% requests’ response time is within 300ms, so the straightforward way is to divide the bucket into several segments, for example, 300ms, 1s, 5s, 10s, +inf, and each bucket contains its <strong>counter</strong> metric which counts the total number of the requests within this bucket,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">http_request_duration_bucket</span><br><span class="line">[0 - 300ms]</span><br><span class="line">[0 - 1s]</span><br><span class="line">[0 - 5s]</span><br><span class="line">[0 - 10s]</span><br><span class="line">[0 - +inf]</span><br></pre></td></tr></table></figure>

<p>You’ll see the bucket is divided and each segment starts from 0 seconds, it means [0 - 1s] will include the [0 - 300ms]. As we said, each bucket metric is of <strong>counter</strong> type, it records the total requests number within that response time and there’s a total count metric called <code>http_request_duration_seconds_count</code>.</p>
<p>To calculate how much does 300ms occupy, we can calculate with <code>http_request_duration_seconds_bucket&#123;le=&quot;0.3&quot;&#125;/http_request_duration_seconds_count</code>, it calculates the instant value of the moment, but if we only use the instant value of that moment, the data will be not smooth and the graph might be spiky, so we’d better use duration to gather more data, <code>sum(rate(http_request_duration_seconds_bucket&#123;le=&quot;0.3&quot;&#125;[5m]))/sum(rate(http_request_duration_seconds_count[5m]))</code>.</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>Similar to a histogram, a summary samples observations (usually things like request durations and response sizes). While it also provides a total count of observations and a sum of all observed values, it calculates configurable quantiles over a sliding time window.  </p>
<h2 id="How-does-query-work"><a href="#How-does-query-work" class="headerlink" title="How does query work?"></a>How does query work?</h2><p>When we use Prometheus to calculate a query, normally we’re using the <strong>query_range</strong> functionality, after a time range and step is specified, the query will be applied to every step and a point will be put into the results.</p>
<p>Let’s see an entire query API:<br><a target="_blank" rel="noopener" href="http://localhost:9090/api/v1/query_range?query=prometheus_target_interval_length_seconds&amp;start=1590830727.588&amp;end=1590834327.588&amp;step=14">http://localhost:9090/api/v1/query_range?query=prometheus_target_interval_length_seconds&amp;start=1590830727.588&amp;end=1590834327.588&amp;step=14</a></p>
<p>it might be a little messy, let’s break it down into parameters,</p>
<ul>
<li>query<br>query is the metric formula that needs to be calculated</li>
<li>Time range (start and end)<br>It is easy to understand, we can specify when should the metrics start and end, I want to see the last 30 minutes or last 7 days, it’s set by the start and end parameters, their format is unix timestamp.</li>
<li>step<br>It is used to decide how many data points we need by setting each data points’ interval and its format is second.</li>
</ul>
<p>The result is too much, I would only paste part of it:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;status&quot;</span><span class="punctuation">:</span> <span class="string">&quot;success&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;resultType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;matrix&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;result&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;metric&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;__name__&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus_target_interval_length_seconds&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;instance&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost:9090&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;interval&quot;</span><span class="punctuation">:</span> <span class="string">&quot;15s&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;job&quot;</span><span class="punctuation">:</span> <span class="string">&quot;prometheus&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;quantile&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.01&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;values&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="punctuation">[</span><span class="number">1590830727.588</span><span class="punctuation">,</span> <span class="string">&quot;14.996369259&quot;</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">                <span class="punctuation">[</span><span class="number">1590830741.588</span><span class="punctuation">,</span> <span class="string">&quot;14.996369259”]</span></span><br><span class="line"><span class="string">            ]</span></span><br><span class="line"><span class="string">        &#125;]</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>status marks the calculation is successful or not</li>
<li>result.metric shows the original metric</li>
<li>result.values shows the actual data points we need, the left value is the timestamp, the right one is the metric value.<br>Each result value’s interval is exactly the step we set, in the previous example, it’s 14 seconds. It means every 14 second, the query will be calculated and one data point is generated.</li>
</ul>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>I explored the query_range API a bit in this article, in the next article, I’ll explore some frequent Prometheus functions like rate, irate, histogram_percentile, etc.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/concepts/metric_types/">Prometheus - Metric types</a></li>
<li><a target="_blank" rel="noopener" href="https://prometheus.io/docs/prometheus/latest/getting_started/">Prometheus - Get started</a></li>
</ul>
<div><h2>Recommended Posts<span style="font-size:0.45em; color:gray">(Driven by<a target="_blank" rel="noopener" href="https://github.com/huiwang/hexo-recommended-posts">Hexo Recommended Posts plugin</a>)</span></h2><ul><li><a href="https://songrgg.github.io/operation/how-to-setup-java-application-memory-limit-in-kubernetes/">How to set up a reasonable memory limit for Java applications in Kubernetes</a></li><li><a href="https://songrgg.github.io/operation/how-to-alert-for-Pod-Restart-OOMKilled-in-Kubernetes/">How to alert for Pod Restart & OOMKilled in Kubernetes</a></li><li><a href="https://songrgg.github.io/operation/how-to-check-and-monitor-tls-jks-certificates-with-telegraf/">How to check and monitor SSL certificates expiration with Telegraf</a></li><li><a href="https://songrgg.github.io/operation/use-grafana-api-generate-dashboards/">Generate monitoring dashboards & alertings using Grafana API</a></li></ul></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/prometheus/">prometheus</a><a class="link-muted mr-2" rel="tag" href="/tags/monitoring/">monitoring</a></div><div class="sharethis-inline-share-buttons"></div><script src="//platform-api.sharethis.com/js/sharethis.js#property=5df54e9fee0f770012eb9f87&amp;product=inline-share-buttons&amp;cms=sop" defer></script></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">Like this article? Support the author with</h3><div class="buttons is-centered"><a class="button donate" href="https://www.buymeacoffee.com/songrgg" target="_blank" rel="noopener" data-type="buymeacoffee"><span class="icon is-small"><i class="fas fa-coffee"></i></span><span>Buy me a coffee</span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/operation/zero-downtime-kubernetes-service-rollout/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Implement zero downtime HTTP service rollout on Kubernetes</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/programming/linux-namespace-part03-cgroups/"><span class="level-item">Linux namespace in Go - Part 3, Cgroups resource limit</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://songrgg.github.io/operation/how-does-prometheus-query-works/';
            this.page.identifier = 'operation/how-does-prometheus-query-works/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'srjiang' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><!--!--><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">SongRong&#039;s Experience</a><p class="is-size-7"><span>&copy; 2023 songrgg</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>