<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Implement zero downtime HTTP service rollout on Kubernetes - Blog | Songrgg</title><meta description="You might have encountered some 5xx errors during http service rollout on Kubernetes and wonder how to make it more reliable without these errors, this article will first explain where this errors com"><meta property="og:type" content="article"><meta property="og:title" content="Implement zero downtime HTTP service rollout on Kubernetes"><meta property="og:url" content="https://songrgg.github.io/operation/zero-downtime-kubernetes-service-rollout/"><meta property="og:site_name" content="Blog | Songrgg"><meta property="og:description" content="You might have encountered some 5xx errors during http service rollout on Kubernetes and wonder how to make it more reliable without these errors, this article will first explain where this errors com"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://songrgg.github.io/images/rollout-with-downtime.webp"><meta property="article:published_time" content="2020-09-16T22:00:00.000Z"><meta property="article:modified_time" content="2020-09-17T23:02:34.895Z"><meta property="article:author" content="songrgg"><meta property="article:tag" content="kubernetes"><meta property="article:tag" content="rollout"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/rollout-with-downtime.webp"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://songrgg.github.io/operation/zero-downtime-kubernetes-service-rollout/"},"headline":"Blog | Songrgg","image":[],"datePublished":"2020-09-16T22:00:00.000Z","dateModified":"2020-09-17T23:02:34.895Z","author":{"@type":"Person","name":"songrgg"},"description":"You might have encountered some 5xx errors during http service rollout on Kubernetes and wonder how to make it more reliable without these errors, this article will first explain where this errors com"}</script><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><!--!--><script src="https://www.googletagmanager.com/gtag/js?id=UA-74431120-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-74431120-1');</script><!--!--><link rel="alternate" href="/atom.xml" title="Blog | Songrgg" type="application/atom+xml">
</head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">SongRong&#039;s Experience</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="/images/rollout-with-downtime.webp" alt="Implement zero downtime HTTP service rollout on Kubernetes"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-09-16T22:00:00.000Z" title="2020-09-16T22:00:00.000Z">2020-09-17</time><span class="level-item"><a class="link-muted" href="/categories/operation/">operation</a></span><span class="level-item">5 minutes read (About 770 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Implement zero downtime HTTP service rollout on Kubernetes</h1><div class="content"><p>You might have encountered some 5xx errors during http service rollout on Kubernetes and wonder how to make it more reliable without these errors, this article will first explain where this errors come from and how to fix them and implement zero downtime.</p>
<a id="more"></a>

<h2 id="Sometimes-you-can’t-see-downtime-because-it’s-hidden"><a href="#Sometimes-you-can’t-see-downtime-because-it’s-hidden" class="headerlink" title="Sometimes you can’t see downtime because it’s hidden"></a>Sometimes you can’t see downtime because it’s hidden</h2><p>First, I would like to share an interesting case before we setup the zero downtime rollout, the client is accessing the service through envoy and fortunately we have <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/router_filter#x-envoy-retry-on">x-envoy-retry-on</a> on <code>connect-failure</code> and <code>gateway-error</code> in envoy, so the client didn’t see any 500 or 503 caused by the service rollout, envoy did all the work to “hide” these errors.</p>
<p>We don’t spend too much time solving the real rollout issue thanks to Envoy, but it’s not a liable solution, the errors are just hidden by some retries. When the envoy configuration is not set correctly, the client will suffer from this.</p>
<h2 id="When-does-it-respond-5xx"><a href="#When-does-it-respond-5xx" class="headerlink" title="When does it respond 5xx?"></a>When does it respond 5xx?</h2><p>According to the Pod lifecycle, there will be two moments when the service can return 5xx (it may be 503 or 500).</p>
<ul>
<li>The moment when the old Pod is killed.</li>
<li>The moment when the new Pod is provisioned.</li>
</ul>
<h3 id="500-error"><a href="#500-error" class="headerlink" title="500 error"></a>500 error</h3><p>When a new Pod is created and it receives traffic before it’s ready, it will respond 500 to the clients. In this case, we need an accurate readiness check on the Pod, only if the readiness is okay, the Pod starts taking traffic.</p>
<h4 id="Ensure-application-container-is-ready"><a href="#Ensure-application-container-is-ready" class="headerlink" title="Ensure application container is ready"></a>Ensure application container is ready</h4><p>The application pod has readiness check, the developer needs to implement a good readiness to ensure the application can start to serve traffic.</p>
<p><img src="/images/unready-pod-500.webp" alt="Unready pod returns 500"></p>
<p>A basic readiness can be the application HTTP server is started, you can also check the hard dependencies of the application are ready. For example, MySQL instances are connected, Redis, Cassandra, Kafka are healthy to connect.</p>
<pre><code><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">readinessProbe:</span></span><br><span class="line">    <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/healthcheck</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span> <span class="comment"># you application port</span></span><br><span class="line">    <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">periodSeconds:</span> <span class="number">3</span></span><br></pre></td></tr></table></figure></code></pre><p>It means when the application is ready, it will wait for initialDelaySeconds (5 seconds in this case) and test the healthcheck API, if it’s healthy then the Pod will be marked ready and it will receive traffic.</p>
<h4 id="Ensure-the-sidecars-are-ready"><a href="#Ensure-the-sidecars-are-ready" class="headerlink" title="Ensure the sidecars are ready."></a>Ensure the sidecars are ready.</h4><p>The readiness of the sidecar container is needed and should be set up the same way as the application container.<br>Some service mesh frameworks, like Istio, every Pod has an Envoy sidecar, all of the outbound requests will go through it and Envoy is ready when its route configuration is fetched from Istio controlplane, more importantly, it must be ready before the application. </p>
<p><strong>If your application needs to initialize resources by calling envoy, you might ensure envoy is ready before the application.</strong></p>
<h3 id="503-error"><a href="#503-error" class="headerlink" title="503 error"></a>503 error</h3><p>When the pod is killed it may still in the load balancer pool for a short time then it will still receive some requests, or it’s processing some in-flight requests which reached the pod before the pod is killed.</p>
<p><img src="/images/killed-pod-503.webp" alt="Killed pod interrupts the in-flight requests and returns 503"></p>
<p>To solve this, we can roughly let the pod wait until it is removed from the LB pool and it finishes all (or most) of the in-flight requests, then it’s safe to shutdown.</p>
<pre><code><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">lifecycle:</span></span><br><span class="line">    <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">'-c'</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sleep</span> <span class="number">15</span><span class="string">;</span></span><br></pre></td></tr></table></figure></code></pre><p>This means before the application exits, it will wait for 15 seconds, after that Kubernetes will send SIGTERM to the container. During this 15 seconds, it will have time to handle the in-flight requests instead of returning 503. 15 second is only a generic duration which we consider it’s enough for the application to finish all the requests, it could be shorter or longer according to the reality.</p>
<p>More advanced case is your application needs to implement some graceful shutdown, for example, recycle the resources, close the MySQL connections or other tasks, this is something implemented in the application code.</p>
<h2 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h2><p>Before we deploy the Kubernetes configuration to the production environment, we can test in the testing environment. Use loadtest tool to simulate a bunch of requests to the Kubernetes application, randomly kill the pod during the test. After the new pod is ready, check if the responses contain 500 or 503.</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ol>
<li><a href="https://www.youtube.com/watch?v=0o5C12kzEDI&ab_channel=CNCF%5BCloudNativeComputingFoundation%5D">The Gotchas of Zero-Downtime Traffic /w Kubernetes</a></li>
<li><a href="https://blog.gruntwork.io/delaying-shutdown-to-wait-for-pod-deletion-propagation-445f779a8304">Delaying shutdown to wait for pod deletion propagation</a></li>
</ol>
<div><h1>Recommended Posts<span style="font-size:0.45em; color:gray">(Driven by<a href="https://github.com/huiwang/hexo-recommended-posts">Hexo Recommended Posts plugin</a>)</span></h1><ul><li><a href="https://songrgg.github.io/operation/hackathon-spinnaker/">My first Hackathon: bring Spinnaker to my company</a></li><li><a href="https://songrgg.github.io/architecture/deeper-understanding-to-envoy/">Anatomy of envoy proxy: the architecture of envoy and how it works</a></li><li><a href="https://songrgg.github.io/operation/istio-version-control-on-k8s/">Istio Version Control On Kubernetes</a></li><li><a href="https://songrgg.github.io/operation/nginx-kubernetes-sidecar-for-better-performance/">以Kubernetes sidecar方式部署Nginx: 提供更好的Web性能</a></li></ul></div></div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/kubernetes/">kubernetes</a><a class="link-muted mr-2" rel="tag" href="/tags/rollout/">rollout</a></div><div class="sharethis-inline-share-buttons"></div><script src="//platform-api.sharethis.com/js/sharethis.js#property=5df54e9fee0f770012eb9f87&amp;product=inline-share-buttons&amp;cms=sop" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/programming/how-does-prometheus-query-works/"><span class="level-item">How does Prometheus query work? - Part 1, Step, Query and Range</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://songrgg.github.io/operation/zero-downtime-kubernetes-service-rollout/';
            this.page.identifier = 'operation/zero-downtime-kubernetes-service-rollout/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'srjiang' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><!--!--><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">SongRong&#039;s Experience</a><p class="size-small"><span>&copy; 2020 songrgg</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://songrgg.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><a id="back-to-top" title="Back to Top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>