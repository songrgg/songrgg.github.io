<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.1"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><title>Setup OAuth2 client for Django in 5 minutes - Blog | Songrgg</title><meta description="This article explains how to setup OAuth2 client for Django in 5 minutes, it’s used for Web service which requires user to login by OAuth2, especially for those who are familiar with OAuth2.0 but unfa"><meta property="og:type" content="article"><meta property="og:title" content="Setup OAuth2 client for Django in 5 minutes"><meta property="og:url" content="https://songrgg.github.io/programming/django-oauth-client-setup/"><meta property="og:site_name" content="Blog | Songrgg"><meta property="og:description" content="This article explains how to setup OAuth2 client for Django in 5 minutes, it’s used for Web service which requires user to login by OAuth2, especially for those who are familiar with OAuth2.0 but unfa"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://songrgg.github.io/images/oauth_flow.webp"><meta property="article:published_time" content="2020-04-12T22:00:00.000Z"><meta property="article:modified_time" content="2020-06-06T23:48:33.567Z"><meta property="article:author" content="songrgg"><meta property="article:tag" content="django"><meta property="article:tag" content="oauth2"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/images/oauth_flow.webp"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://songrgg.github.io/programming/django-oauth-client-setup/"},"headline":"Blog | Songrgg","image":[],"datePublished":"2020-04-12T22:00:00.000Z","dateModified":"2020-06-06T23:48:33.567Z","author":{"@type":"Person","name":"songrgg"},"description":"This article explains how to setup OAuth2 client for Django in 5 minutes, it’s used for Web service which requires user to login by OAuth2, especially for those who are familiar with OAuth2.0 but unfa"}</script><link rel="icon" href="/images/favicon.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><!--!--><script src="https://www.googletagmanager.com/gtag/js?id=UA-74431120-1" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-74431120-1');</script><!--!--><link rel="alternate" href="/atom.xml" title="Blog | Songrgg" type="application/atom+xml">
</head><body class="is-1-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">SongRong&#039;s Experience</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-12"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="thumbnail" src="/images/oauth_flow.webp" alt="Setup OAuth2 client for Django in 5 minutes"></span></div><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-04-12T22:00:00.000Z" title="2020-04-12T22:00:00.000Z">2020-04-13</time><span class="level-item"><a class="link-muted" href="/categories/programming/">programming</a></span><span class="level-item">4 minutes read (About 564 words)</span></div></div><h1 class="title is-3 is-size-4-mobile">Setup OAuth2 client for Django in 5 minutes</h1><div class="content"><p>This article explains how to setup OAuth2 client for Django in 5 minutes, it’s used for Web service which requires user to login by OAuth2, especially for those who are familiar with OAuth2.0 but unfamiliar with Django.</p>
<p>If you have no idea about OAuth2.0 workflow, please visit <a href="https://oauth.net/2/">OAuth2 net</a></p>
<a id="more"></a>

<p>The example here introduces Web service implements the OAuth2 workflow, the user must login first then he can see the web content. The Web Framework is Python Django, the OAuth library we use is <code>Authlib==0.14.1</code>. It supports user session persistence and auto-refresh access_token.</p>
<h2 id="OAuth-configuration"><a href="#OAuth-configuration" class="headerlink" title="OAuth configuration"></a>OAuth configuration</h2><p>If we consider using Github as the authorization server, first you need to <a href="https://github.com/settings/applications/new">register a new OAuth application in Github</a>, then you’ll have you credentials.<br>Secondly, setup OAuth settings in <code>settings.py</code>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># OAuth Settings</span></span><br><span class="line">OAUTH_URL_WHITELISTS = []</span><br><span class="line"></span><br><span class="line">OAUTH_CLIENT_NAME = <span class="string">'github'</span></span><br><span class="line"></span><br><span class="line">OAUTH_CLIENT = &#123;</span><br><span class="line">    <span class="string">'client_id'</span>: <span class="string">''</span>,</span><br><span class="line">    <span class="string">'client_secret'</span>: <span class="string">''</span>,</span><br><span class="line">    <span class="string">'access_token_url'</span>: <span class="string">'https://github.com/login/oauth/access_token'</span>,</span><br><span class="line">    <span class="string">'authorize_url'</span>: <span class="string">'https://github.com/login/oauth/authorize'</span>,</span><br><span class="line">    <span class="string">'api_base_url'</span>: <span class="string">'https://api.github.com/'</span>,</span><br><span class="line">    <span class="string">'redirect_uri'</span>: <span class="string">'https://songrgg.com/oauth/callback'</span>,</span><br><span class="line">    <span class="string">'client_kwargs'</span>: &#123;</span><br><span class="line">        <span class="string">'scope'</span>: <span class="string">'profile email'</span>,</span><br><span class="line">        <span class="string">'token_placement'</span>: <span class="string">'header'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'userinfo_endpoint'</span>: <span class="string">'user'</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Pay attention, the redirect uri should be the one your server will use to fetch access token and setup user session, I setup <code>/oauth/callback</code> here, the logic will be introduced in middleware.</p>
<h2 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a>Middleware</h2><p>For each user request, the server will check user’s session and see if user has logined, in both Django or other Web frameworks, we could setup middleware to handle user requests.</p>
<h3 id="Initialize-the-OAuth-client"><a href="#Initialize-the-OAuth-client" class="headerlink" title="Initialize the OAuth client"></a>Initialize the OAuth client</h3><p>Use the OAuth configuration to initialize the OAuth client.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_token</span><span class="params">(token, refresh_token, access_token)</span>:</span></span><br><span class="line">    request.session[<span class="string">'token'</span>] = token</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">sso_client = self.oauth.register(</span><br><span class="line">    settings.OAUTH_CLIENT_NAME, overwrite=<span class="literal">True</span>, **settings.OAUTH_CLIENT, update_token=update_token</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><code>update_token</code> parameter is used to refresh the access_token when it’s expired.</p>
<h3 id="Process-OAuth-callback"><a href="#Process-OAuth-callback" class="headerlink" title="Process OAuth callback"></a>Process OAuth callback</h3><p>After the user authorizes the login, our server should fetch the access_token from the authorization server and store it in user session.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> request.path.startswith(<span class="string">'/oauth/callback'</span>):</span><br><span class="line">    self.clear_session(request)</span><br><span class="line">    request.session[<span class="string">'token'</span>] = sso_client.authorize_access_token(request)</span><br><span class="line">    <span class="keyword">if</span> self.get_current_user(sso_client, request) <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        redirect_uri = request.session.pop(<span class="string">'redirect_uri'</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> redirect_uri <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(redirect_uri)</span><br><span class="line">        <span class="keyword">return</span> redirect(views.index)</span><br></pre></td></tr></table></figure>

<h3 id="Fetch-user-info"><a href="#Fetch-user-info" class="headerlink" title="Fetch user info"></a>Fetch user info</h3><p>After the <code>access_token</code> is ready, fetch the user info from the resource API, otherwise redirect user to the authorization page.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@staticmethod</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_current_user</span><span class="params">(sso_client, request)</span>:</span></span><br><span class="line">    token = request.session.get(<span class="string">'token'</span>, <span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">if</span> token <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="string">'access_token'</span> <span class="keyword">not</span> <span class="keyword">in</span> token:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> OAuth2Token.from_dict(token).is_expired() <span class="keyword">and</span> <span class="string">'user'</span> <span class="keyword">in</span> request.session:</span><br><span class="line">        <span class="keyword">return</span> request.session[<span class="string">'user'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        res = sso_client.get(settings.OAUTH_CLIENT[<span class="string">'userinfo_endpoint'</span>], token=OAuth2Token(token))</span><br><span class="line">        <span class="keyword">if</span> res.ok:</span><br><span class="line">            request.session[<span class="string">'user'</span>] = res.json()</span><br><span class="line">            <span class="keyword">return</span> res.json()</span><br><span class="line">    <span class="keyword">except</span> OAuthError <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<h3 id="Put-the-middleware"><a href="#Put-the-middleware" class="headerlink" title="Put the middleware"></a>Put the middleware</h3><p>In <code>settings.py</code>, put the middleware class to the array.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">'oauth_demo.middleware.oauth.OAuthMiddleware'</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h2><p>We use Django session module and the default storage is <code>sqlite3</code>, you can simply change it to other backends like <code>redis</code> by modifying <code>settings.py</code>.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>The full repository is located at <a href="https://github.com/songrgg/oauth-demo">https://github.com/songrgg/oauth-demo</a>.</p>
</div><div class="article-tags size-small mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/django/">django</a><a class="link-muted mr-2" rel="tag" href="/tags/oauth2/">oauth2</a></div><div class="sharethis-inline-share-buttons"></div><script src="//platform-api.sharethis.com/js/sharethis.js#property=5df54e9fee0f770012eb9f87&amp;product=inline-share-buttons&amp;cms=sop" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/programming/linux-namespace-part01-uts-pid/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Linux namespace in Go - Part 1, UTS and PID</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/operation/influxdb-command-cheatsheet/"><span class="level-item">InfluxDB command cheatsheet</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">Comments</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://songrgg.github.io/programming/django-oauth-client-setup/';
            this.page.identifier = 'programming/django-oauth-client-setup/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'srjiang' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><!--!--><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">SongRong&#039;s Experience</a><p class="size-small"><span>&copy; 2020 songrgg</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'https://songrgg.github.io',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><a id="back-to-top" title="Back to Top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>