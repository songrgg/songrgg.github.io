<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 基于gitlab搭建CI · Songrgg's Blog</title><meta name="description" content="基于gitlab搭建CI - songrgg"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://songrgg.github.io/atom.xml" title="Songrgg's Blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/songrgg" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">基于gitlab搭建CI</h1><div class="post-info">Apr 18, 2017</div><div class="post-content"><h4 id="自建gitlab"><a href="#自建gitlab" class="headerlink" title="自建gitlab"></a>自建gitlab</h4><p>自建gitlab一大优势是<strong>快</strong>，之前用翻墙走github速度也在1M/s左右，可是自建的gitlab提升了建立连接的速度，可以说体验又上升了一个档次。</p>
<p>用docker起一个gitlab服务尤其方便 <a href="https://docs.gitlab.com/omnibus/docker/README.html" target="_blank" rel="noopener">GitLab Docker images</a></p>
<h4 id="选择CI"><a href="#选择CI" class="headerlink" title="选择CI"></a>选择CI</h4><p>如果有人像我一样对Jenkins的UI和配置不感兴趣，那么Gitlab CI runner是不错的选择，配置用<code>YAML</code>，清晰明了，UI集成在gitlab中。<strong>对比jenkins，上手容易，颜值更高。</strong></p>
<h4 id="Gitlab-CI-runner"><a href="#Gitlab-CI-runner" class="headerlink" title="Gitlab CI runner"></a>Gitlab CI runner</h4><ul>
<li>找一台ubuntu 16.04，机器配置按照项目大小和数量决定</li>
<li><p>安装CI runner</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install gitlab-ci-multi-runner</span><br></pre></td></tr></table></figure>
</li>
<li><p>将runner注册到gitlab</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo gitlab-ci-multi-runner register</span><br></pre></td></tr></table></figure>
</li>
<li><p>调整配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">concurrent</span> <span class="string">=</span> <span class="number">16</span> <span class="comment"># 更新并发build数量到16</span></span><br><span class="line"></span><br><span class="line"><span class="string">[[runners]]</span></span><br><span class="line">  <span class="string">name</span> <span class="string">=</span> <span class="string">"10-1-10-10"</span> <span class="comment"># 这里是runner的名字</span></span><br><span class="line">  <span class="string">url</span> <span class="string">=</span> <span class="string">"https://gitlab.com"</span> <span class="comment"># 所属gitlab的url</span></span><br><span class="line">  <span class="string">token</span> <span class="string">=</span> <span class="string">"please-input-gitlab-register-token"</span> <span class="comment"># gitlab注册token</span></span><br><span class="line">  <span class="string">executor</span> <span class="string">=</span> <span class="string">"docker"</span> <span class="comment"># 以docker形式运行每次CI任务</span></span><br><span class="line">  <span class="string">[runners.docker]</span></span><br><span class="line">    <span class="string">tls_verify</span> <span class="string">=</span> <span class="literal">false</span></span><br><span class="line">    <span class="string">image</span> <span class="string">=</span> <span class="string">"ruby:2.1"</span> <span class="comment"># docker运行的默认镜像</span></span><br><span class="line">    <span class="string">privileged</span> <span class="string">=</span> <span class="literal">false</span> <span class="comment"># 不授权</span></span><br><span class="line">    <span class="string">volumes</span> <span class="string">=</span> <span class="string">["/cache",</span> <span class="string">"/var/run/docker.sock:/var/run/docker.sock"</span><span class="string">]</span></span><br><span class="line">    <span class="string">extra_hosts</span> <span class="string">=</span> <span class="string">["gitlab.com:some-internal-ip"]</span></span><br><span class="line">  <span class="string">[runners.cache]</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p><strong>调整<em>concurrent</em>，最大限度利用机器</strong><br><strong>若镜像中使用<code>docker push</code>等命令，将宿主机<em>docker.sock</em>挂载到容器中</strong><br><strong>若gitlab与runner在同网络，设置docker容器内的gitlab host为内网IP，最小化网络延迟</strong></p>
</blockquote>
<h4 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h4><p>pipeline指CI的流程可以当做管道，只有上一个操作成功之后，下一个操作继续执行，如利用gitlab ci构建build-&gt;test-&gt;release-&gt;deployment的流程，当代码push到<code>master</code>时，CI触发，如下<br><img src="/images/gitlabci.png" alt="gitlabci"></p>
<h4 id="配置CI"><a href="#配置CI" class="headerlink" title="配置CI"></a>配置CI</h4><p><strong>.gitlab-ci.yml</strong>是gitlab项目的CI配置文件，文件形式是<code>yaml</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">image:</span> <span class="attr">ruby:2.1</span></span><br><span class="line"><span class="attr">stages:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">test</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">build</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">release</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">deployment</span></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line"><span class="attr">  DOCKER_DRIVER:</span> <span class="string">overlay</span></span><br><span class="line"><span class="attr">  SERVICE_NAME:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">  CONTAINER_TEST_IMAGE:</span> <span class="string">$IMAGE_NAME:$CI_BUILD_REF_NAME</span></span><br><span class="line"><span class="attr">  CONTAINER_RELEASE_IMAGE:</span> <span class="string">$IMAGE_NAME:latest</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:</span><span class="number">1.8</span><span class="number">.0</span><span class="string">:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="attr">golang:1.8</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">  before_script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">"before test"</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">"test"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span><span class="attr">test:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="attr">golang:1.8</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">build</span></span><br><span class="line"><span class="attr">  before_script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">"before script"</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">mkdir</span> <span class="bullet">-p</span> <span class="string">binaries/</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">touch</span> <span class="string">binaries/test</span></span><br><span class="line"><span class="attr">  artifacts:</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">binaries/</span></span><br><span class="line"><span class="attr">    expire_in:</span> <span class="number">1</span><span class="string">h</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span><span class="attr">prod:</span></span><br><span class="line"><span class="attr">  image:</span> <span class="attr">golang:1.8</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">build</span></span><br><span class="line"><span class="attr">  before_script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">"before build"</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">mkdir</span> <span class="bullet">-p</span> <span class="string">binaries/</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">touch</span> <span class="string">binaries/prod</span></span><br><span class="line"><span class="attr">  artifacts:</span></span><br><span class="line"><span class="attr">    paths:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">binaries/</span></span><br><span class="line"><span class="attr">    expire_in:</span> <span class="number">1</span><span class="string">h</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="attr">release:</span><span class="attr">test:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">release</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">"release $CONTAINER_TEST_IMAGE"</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test</span></span><br><span class="line"><span class="attr">  dependencies:</span></span><br><span class="line"><span class="attr">    - build:</span><span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">release:</span><span class="attr">prod:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">release</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">"release $CONTAINER_RELEASE_IMAGE"</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">  dependencies:</span></span><br><span class="line"><span class="attr">    - build:</span><span class="string">prod</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deployment:</span><span class="attr">test:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">deployment</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">kroniak/ssh-client</span></span><br><span class="line"><span class="attr">  before_script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">"before script"</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">"deployment test"</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">deployment:</span><span class="attr">stage:</span></span><br><span class="line"><span class="attr">  stage:</span> <span class="string">deployment</span></span><br><span class="line"><span class="attr">  image:</span> <span class="string">kroniak/ssh-client</span></span><br><span class="line"><span class="attr">  before_script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">"before script"</span></span><br><span class="line"><span class="attr">  only:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">  script:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">echo</span> <span class="string">"deployment stage"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>stage声明管道有几个阶段，stage的顺序代表着前置stage完成后才能进入下一个stage，每个stage有1个或多个可执行点</li>
<li>每个可执行操作里有一些配置<ul>
<li>stage<br>当前执行所属阶段，就是文件开头声明的<code>stages</code>列表中一个</li>
<li>image<br>当前命令执行的基础镜像</li>
<li>before_script<br>脚本执行前初始化命令</li>
<li>only<br>限制执行的分支，例如只有test分支能触发<code>deployment:test</code></li>
<li>script(required)<br>执行的脚本</li>
<li>artifacts<br>这次执行将产生的需要传递给下一个stage的文件</li>
<li>dependencies<br>当前执行依赖的前置执行，不仅是声明一种依赖关系，同时上个执行生成的artifacts也会传递过来</li>
</ul>
</li>
<li>在gitlab项目中设置<strong>CI/CD Pipelines</strong>的<code>variables</code>，可以为docker容器注入隐秘变量，如docker仓库秘钥，这些变量可以在CI运行脚本时被解析。</li>
</ul>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>Gitlab CI能自定义阶段和在容器里执行脚本，并且水平拓容便捷，和Gitlab的集成好。</p>
</div></article></div></main><footer><div class="paginator"><a href="/ratelimit/rate-limiter-for-distributed-system/" class="prev">PREV</a><a href="/microservice/microservice-in-action-4/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'srjiang';
var disqus_identifier = 'gitlab/build-ci-with-gitlab/';
var disqus_title = '基于gitlab搭建CI';
var disqus_url = 'https://songrgg.github.io/gitlab/build-ci-with-gitlab/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//srjiang.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2018 <a href="https://songrgg.github.io">songrgg</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-74431120-1",'auto');ga('send','pageview');</script></body></html>